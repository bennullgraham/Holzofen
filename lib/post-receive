#/bin/sh
HOLZOFEN_DIR="/var/www/Holzofen"
DOC_SRC_DIR="${HOLZOFEN_DIR}/docs"

# backup DB
mongodump -d holzofen -c firings -o- | gzip -c > "${HOLZOFEN_DIR}/mongo.dump.gz"

# new files
GIT_WORK_TREE="${HOLZOFEN_DIR}/" git checkout -f

# build docs
cd "${DOC_SRC_DIR}" && make html

# half-arsed clean of assets
rm -rf "${HOLZOFEN_DIR}/holzofen/static/src/.webassets-cache"
rm "${HOLZOFEN_DIR}/holzofen/static/js/app.js"

# this may be necessary for gevent to pick up the update
touch "${HOLZOFEN_DIR}/Holzofen.py"

# request to trigger rebuild of assets
wget -q -O- localhost:5001 > /dev/null
